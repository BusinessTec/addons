function pos_loyalty_bg_db(instance, module) {

    module.PosDB = module.PosDB.extend({
        init: function (options) {
            options = options || {};
            this._super(options);
            this.loyalty = {};
            this.loyalty.rules = {};
            this.loyalty.rules_by_product_id = {};
            this.loyalty.rules_by_category_id = {};
            this.loyalty.rewards = {};
            this.loyalty.rewards_by_id = {};
        },
        add_loyalty: function(){
        },
        add_rules: function(rules){
            this.loyalty.rules = rules || {};
            rules.sort(function(a, b){return a['sequence']-b['sequence']});
            for (var i = 0; i < rules.length; i++){
                var rule = rules[i];
                if (rule.product_id[0] && rule.category_id[0] == False) {
                    var product =this.db.get_product_by_id(rule.product_id[0]);
                    if (!this.loyalty.rules_by_product_id[product.id[0]]) {
                        this.loyalty.rules_by_product_id[product.id[0]] = [rule];
                    } else if (rule.cumulative) {
                        this.loyalty.rules_by_product_id[product.id[0]].unshift(rule);
                    } else {
                        this.loyalty.rules_by_product_id[product.id[0]].push(rule);
                    }
                } else if (rule.product_id[0] == False && rule.category_id[0]) {
                    var category = this.db.get_category_by_id(rule.category_id[0]);
                    if (!this.loyalty.rules_by_category_id[category.id]) {
                    this.loyalty.rules_by_category_id[category.id] = [rule];
                    } else if (rule.cumulative) {
                    this.loyalty.rules_by_category_id[category.id].unshift(rule);
                    } else {
                    this.loyalty.rules_by_category_id[category.id].push(rule);
                    }
                }
            }
        },
        add_rewards: function(rewards) {
           this.loyalty.rewards = rewards || {};
           for (var i = 0; i < rewards.length;i++) {
                this.loyalty.rewards_by_id[rewards[i].id] = rewards[i];
           }
        },
    })

}
